{
    "collab_server" : "",
    "contents" : "library(readxl)\nlibrary(stringr)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(purrr)\nlibrary(lubridate)\nlibrary(ggplot2)\nlibrary(viridis)\n\n# list data sheets to be read in (all communes per dept)\nlist_db_paths <- dir('data', full.names = TRUE)\nlist_dept <- c('DSGA', 'DSS')\n\nWrangleData <- function(dept = NULL){\n  \n  list_path <- list_db_paths[str_detect(list_db_paths, dept) == TRUE]\n  \n  sheetnames <- excel_sheets(list_path)\n  \n  exclude_sheets <- \n    c(\n      sheetnames[str_detect(sheetnames, 'Sheet') == TRUE],\n      sheetnames[str_detect(sheetnames, 'List') == TRUE],\n      sheetnames[str_detect(sheetnames, 'DS') == TRUE],\n      sheetnames[str_detect(sheetnames, 'Inst') == TRUE],\n      'Ouverture', 'A', 'Z', 'BTS', \"Taux d'Attaque\", 'Report_staging', 'Tableaux_Tests Cholera'\n    )\n  \n  list_commune <- sheetnames[!sheetnames %in% exclude_sheets]\n  \n  PrepareData <- function(dept = NULL, commune = 'Baraderes') {\n    \n    dat <- \n      read_excel(path = list_path, sheet = commune, skip = 8) %>% \n      setNames(make.names(names(.)))\n    \n    dat_names <- \n      c('date', 'epiweek', 'cas_vus_<5', 'cas_vus_5+', 'cas_vus_tot', 'cas_hosp_<5', 'cas_hosp_5+', 'cas_hosp_tot', 'deces_inst_<5', 'deces_inst_5+', 'deces_inst_tot', 'deces_comm_<5', 'deces_comm_5+', 'deces_comm_tot', 'deces_tot_no_age', 'deces_tot')\n    \n    dat <-\n      dat[1:16] %>%\n      setNames(dat_names) %>%\n      mutate(\n        dept = dept,\n        commune = commune,\n        year = year(date),\n        month = month(date, label = TRUE),\n        week_year = paste(year(date), ifelse(nchar(isoweek(date)) == 1, paste0('0', isoweek(date)), isoweek(date)), sep = '-'),\n        epiweek_year = paste(year(date), ifelse(nchar(epiweek) == 1, paste0('0', epiweek), epiweek), sep = '-')\n      ) %>%\n      select(dept, commune, date, month, week_year, epiweek_year, everything())\n\n    return(dat)\n    \n  }\n  \n  list_dat <- map(list_commune, PrepareData, dept = dept) %>% set_names(list_commune) %>% bind_rows\n  return(list_dat)\n  \n}\n  \nlist_dat <- map(list_dept[1], WrangleData)\n\n# dat <- \n#   list_dat %>% \n#   bind_rows %>% \n#   filter(date < today()) %>% \n#   group_by(dept, commune, date, year, month, epiweek_year, epiweek) %>% \n#   summarise(n = sum(cas_vus_tot))\n\nAnalyseData <- function(data = NULL, variable = NULL){\n\n  data %>%\n    bind_rows %>%\n    filter(date < today()) %>%\n    group_by(dept, commune, date, year, month, epiweek_year, epiweek) %>%\n    summarise_(n = lazyeval::interp(~sum(var), var = as.name(variable)))\n    \n}\n\nlist_variables <- c('cas_vus_tot', 'cas_hosp_tot', 'deces_inst_tot', 'deces_comm_tot', 'deces_tot')\n\n# tmp <- AnalyseData(data = list_dat, variable = 'cas_hosp_tot')\n\nlist_dat <- map(list_variables, AnalyseData, data = list_dat) %>% set_names(list_variables)\n\n# dat <- bind_rows(tmp, .id = 'variable')\n\n# plots\n\nPlotHistYear <- function(data = NULL){\n\n  ggplot(data) +\n    geom_bar(aes(x = month, y = n, fill = factor(year)), stat = 'identity') +\n    scale_fill_viridis(discrete = TRUE) +\n    facet_wrap(~year) +\n    ggthemes::theme_tufte()\n  \n}\n\nlist_hist_year <- map(list_dat, PlotHistYear)\n  \nPlotHistCommune <- function(data = NULL){\n  \n  ggplot(filter(data, year >= 2015)) +\n    geom_bar(aes(x = epiweek_year, y = n, fill = commune), stat = 'identity') +\n    scale_fill_viridis(discrete = TRUE) +\n    facet_wrap(~commune) +\n    ggthemes::theme_tufte()\n  \n}\n\nlist_hist_commune <- map(list_dat, PlotHistCommune)\n\n# since the hurricane\nlist_dat_post_hurr <- map(list_dat, function(data) data %>% filter(year == '2016', epiweek >= 40) %>% mutate(epiweek = factor(epiweek)))\n\n# by day\nPlotHistDayPostHurr <- function(data = NULL){\n  \n  ggplot(data, aes(x = date, y = n, fill = commune)) +\n    geom_bar(stat = 'identity') +\n    # geom_text(label = dat_post_hurr %>% group_by(date) %>% summarise(n = sum(n))) +\n    scale_fill_viridis(discrete = TRUE) +\n    labs(x = 'Date', y = '# cases') +\n    ggthemes::theme_tufte()\n  \n}\n\nlist_hist_day_post_hurr <- map(list_dat_post_hurr, PlotHistDayPostHurr)\n\n# by week\nPlotHistWeekPostHurr <- function(data = NULL){\n  \n  ggplot(data, aes(x = date, y = n, fill = commune)) +\n    geom_bar(aes(x = epiweek, y = n, fill = commune), stat = 'identity') +\n    scale_fill_viridis(discrete = TRUE) +\n    labs(x = 'Epiweek 2016', y = '# cases') +\n    ggthemes::theme_tufte()\n  \n}\n\nlist_hist_week_post_hurr <- map(list_dat_post_hurr, PlotHistWeekPostHurr)\n\n# by week & commune\nPlotHistWeekCommunePostHurr <- function(data = NULL){\n  \n  ggplot(data) +\n    geom_bar(aes(x = epiweek, y = n, fill = commune), stat = 'identity') +\n    scale_fill_viridis(discrete = TRUE) +\n    facet_wrap(~commune) +\n    labs(x = 'Epiweek 2016', y = '# cases') +\n    ggthemes::theme_tufte()\n  \n}\n\nlist_hist_week_commune_post_hurr <- map(list_dat_post_hurr, PlotHistWeekCommunePostHurr)\n",
    "created" : 1478806512361.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2742163891",
    "id" : "60B12240",
    "lastKnownWriteTime" : 1479064760,
    "last_content_update" : 1479064760802,
    "path" : "~/OneDrive/who/projects/haiti_cholera_2016/rough.R",
    "project_path" : "rough.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}