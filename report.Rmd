---
output:
  tufte::tufte_handout:
    latex_engine: pdflatex
    pandoc_args:
    - --include-in-header
    - includes/styles.sty
    - --include-before-body
    - includes/titlepage.tex
  html_document: default
  word_document: default
params:
  dep_san: DSGA
---

`r if(knitr::opts_knit$get("rmarkdown.pandoc.to") == 'docx') {'---\ntitle: Situation épidémiologique de la diarrhée aiguë après l’ouragan Matthew\nsubtitle: Département de la Grand’ Anse, Haiti\n---'}`

```{r, cache=FALSE, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}
knitr::opts_chunk$set(cache=FALSE, message=FALSE, echo=FALSE, warning=FALSE, results='asis')
knitr::knit_hooks$set(inline = function(x) if (is.numeric(x)) round(x, 1) )

load('ws.RData')
source('functions.R')

# list_db_paths <- dir('data', full.names = TRUE)
# list_depts <-
#   list_db_paths[str_detect(list_db_paths, 'Surveillance Cholera_2015_2016')] %>%
#   str_replace_all(c('data/' = '', '[-_]Surveillance Cholera.*' = ''))
list_depts <- params$dep_san

# df_nested <-
#   list_depts %>% 
#   map(WrangleData) %>% 
#   bind_rows() %>% 
#   nest(-c(dept), .key = data_by_age) %>%
#   mutate(
#     # data sets
#     data = map(data_by_age, MergeAges) %>% set_names(list_depts),
#     data_pie = map(data_by_age, WrangleDataPie, variable = 'cas_vus') %>% set_names(list_depts),
#     data_map = map2(data, dept, WrangleDataMapPopAR) %>% set_names(list_depts),
#     # table
#     epitable = map(data, MakeTable) %>% set_names(list_depts),
#     # plots
#     ## epicurves
#     epicurve_by_day_all = map(data, PlotHistDay) %>% set_names(list_depts),
#     # epicurve_by_week_all = map(data, PlotHistWeek) %>% set_names(list_depts),
#     epicurve_by_week_commune = map(data, PlotHistWeekCommune) %>% set_names(list_depts),
#     epicurve_by_week_inst = map(data, PlotHistWeekInst) %>% set_names(list_depts),
#     ## proportion plots
#     pie_cases_by_commune = map(data_pie, PlotPie, colour_scheme = 'RdBu', key = 'commune') %>% set_names(list_depts),
#     bar_cases_by_commune = map(data_pie, PlotBar, colour_scheme = 'RdBu', facet_var = 'commune') %>% set_names(list_depts),
#     ## map
#     map = map(data_map, MakeMapAR) %>% set_names(list_depts)
#   )
```

<!-- -	Analyse base de données de diarrhées aigues sévères de la Grand’Anse -->
<!-- -	Investigation de décès institutionnels a Dame Marie, Recherche active communautaire et reponse -->
<!-- -	Evaluation de la qualité des données cholera a Dame Marie, Chambellan et Moron -->

# Analyse des données de diarrhées aigues:

```{r, fig.fullwidth = TRUE, fig.cap = paste0("Tendance des cas de diarrhées aigues, ", df_nested$data[[list_depts]]$date %>% min %>% format('%d %b %Y'), " - ", df_nested$data[[list_depts]]$date %>% max %>% format('%d %b %Y'), " Grand’Anse (données partielles).")}
# plot by day
df_nested$epicurve_by_day_all[[list_depts]]
```

```{r, fig.fullwidth = F, fig.height = 3, fig.cap = paste0("Répartition des cas de diarrhées aigues par commune, ", df_nested$data[[list_depts]]$date %>% min %>% format('%d %b %Y'), " - ", df_nested$data[[list_depts]]$date %>% max %>% format('%d %b %Y'), " Grand’Anse (données partielles).")}
df_nested$pie_cases_by_commune[[list_depts]]
```

\clearpage

\begin{fullwidth}
\makeatletter\setlength\hsize{\@tufte@fullwidth}\setlength\linewidth{\@tufte@fullwidth}\let\caption\@tufte@orig@caption\makeatother
\footnotesize
```{r, tab_overview}
if(nrow(df_nested$epitable[[list_depts]])>1) {rws <- seq(1, nrow(df_nested$epitable[[list_depts]]) - 1, by = 2)}

df_nested$epitable[[list_depts]] %>% 
  xtable::xtable(
    caption = paste0("Répartition des cas de diarrhées aigues par CTC/UTC, ", df_nested$data[[list_depts]]$date %>% min %>% format('%d %b %Y'), " - ", df_nested$data[[list_depts]]$date %>% max %>% format('%d %b %Y'), " Grand’Anse (données partielles)."), 
    digits = 0, label = "tab_overview", align = 'lllrrrr'
  ) %>% 
  print(booktabs = TRUE, caption.placement = "top", add.to.row = list(pos = as.list(rws), command = rep("\\rowcolor{whoblue!15}", length(rws))), include.rownames = FALSE, comment = FALSE, tabular.environment = 'longtable', floating = FALSE)
```
\end{fullwidth}


```{r}
# print table if output is word or html document
if(knitr::opts_knit$get("rmarkdown.pandoc.to") %in% c('docx', 'html')) knitr::kable(df_nested$epitable[[list_depts]])
```

\newpage

```{r, fig.fullwidth = TRUE, fig.height=5, fig.cap = paste0("Répresentation du taux d'attaque des cas de diarrhées aigues par 10,000 personnes, ", df_nested$data[[list_depts]]$date %>% min %>% format('%d %b %Y'), " - ", df_nested$data[[list_depts]]$date %>% max %>% format('%d %b %Y'), " par commune, Grand’Anse (données partielles).")}
df_nested$map[[list_depts]]
```

\newpage

```{r, fig.fullwidth = TRUE, fig.height=4, fig.cap = paste0("Tendance des cas de diarrhées aigues, ", df_nested$data[[list_depts]]$date %>% min %>% format('%d %b %Y'), " - ", df_nested$data[[list_depts]]$date %>% max %>% format('%d %b %Y'), " par commune, Grand’Anse (données partielles).")}
# by week & commune
df_nested$epicurve_by_week_commune[[list_depts]]
```

\newpage

```{r, fig.fullwidth = F, fig.height=3, fig.cap = paste0("Répartition des cas de diarrhées aigues par tranche d'age, ", df_nested$data[[list_depts]]$date %>% min %>% format('%d %b %Y'), " - ", df_nested$data[[list_depts]]$date %>% max %>% format('%d %b %Y'), " par commune, Grand’Anse (données partielles).")}
df_nested$bar_cases_by_commune[[list_depts]]
```

\newpage

```{r, fig.fullwidth = TRUE, fig.height=4, fig.cap = paste0("Tendance des cas de diarrhées aigues, ", df_nested$data[[list_depts]]$date %>% min %>% format('%d %b %Y'), " - ", df_nested$data[[list_depts]]$date %>% max %>% format('%d %b %Y'), " par CTC, Grand’Anse (données partielles).")}
# by week & inst
df_nested$epicurve_by_week_inst[[list_depts]]
```

