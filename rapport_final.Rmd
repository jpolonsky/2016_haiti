---
output:
  tufte::tufte_handout:
    latex_engine: pdflatex
    pandoc_args:
    - --include-in-header
    - includes/styles.sty
    - --include-before-body
    - includes/titlepage_final_report.tex
  html_document: default
  word_document: default
params:
  dep_san: DSGA
---

`r if(knitr::opts_knit$get("rmarkdown.pandoc.to") == 'docx') {'---\ntitle: Ouragan Matthew réponse, Département de la Grand’ Anse, Haiti\nsubtitle: Rapport sur le renforcement de la surveillance épidémiologique et gestion des données\nauthor: Jonathan Polonsky, Epidemiologist, WHO Emergencies Programme\ndate: system.Date()\n---'}`

```{r, cache=FALSE, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}
knitr::opts_chunk$set(cache=FALSE, message=FALSE, echo=FALSE, warning=FALSE, results='asis')
knitr::knit_hooks$set(inline = function(x) if (is.numeric(x)) round(x, 1) )

load('ws.RData')
source('functions.R')

# list_depts <- params$dep_san
```

<!-- # Post-Hurricane Matthew réponse
# Mission report on epidemiology, surveillance & data management
*Jonathan Polonsky, Epidemiologist, WHO Emergencies Programme* -->

## Background


## Overview

- need to rebuild surveillance
  + community based
  + line list to cpature essential variables for analysis
  + ewars-like system to improve data flow
  + describe weaknesses
    * 2-level sensitivity analysis
      - from community to CTC
      - from CTC to central level
      - develop methodology for this

- describe the process of calling for aggregated updates

- regular field visits for:
  + investigations (alerts, community deaths, clusters of cases/deaths, etc)
  + multidisciplinary visits for rationalising resources - prevents repeated trips to same locations and added burden to staff at CTCs
  + collecting and comparing 

## Analysis of key indicators
```{r, fig.fullwidth = TRUE, fig.cap = paste0("Tendance des cas de diarrhées aigues, ", DisplayResult('data')$date %>% min %>% format('%d %b %Y'), " - ", DisplayResult('data')$date %>% max %>% format('%d %b %Y'), " Grand’Anse (données partielles).")}
# plot by day
DisplayResult('epicurve_by_day_all')
```

```{r, fig.fullwidth = F, fig.height = 3, fig.cap = paste0("Répartition des cas de diarrhées aigues par commune, ", DisplayResult('data')$date %>% min %>% format('%d %b %Y'), " - ", DisplayResult('data')$date %>% max %>% format('%d %b %Y'), " Grand’Anse (données partielles).")}
# df_nested$pie_cases_by_commune[[list_depts]]
DisplayResult('pie_cases_by_commune')
```

\clearpage

\begin{fullwidth}
\makeatletter\setlength\hsize{\@tufte@fullwidth}\setlength\linewidth{\@tufte@fullwidth}\let\caption\@tufte@orig@caption\makeatother
\footnotesize
```{r, tab_overview}
if(nrow(DisplayResult('epitable'))>1) {rws <- seq(1, nrow(DisplayResult('epitable')) - 1, by = 2)}

DisplayResult('epitable') %>% 
  xtable::xtable(
    caption = paste0("Répartition des cas de diarrhées aigues par CTC/UTC, ", DisplayResult('data')$date %>% min %>% format('%d %b %Y'), " - ", DisplayResult('data')$date %>% max %>% format('%d %b %Y'), " Grand’Anse (données partielles)."), 
    digits = 0, label = "tab_overview", align = 'lllrrrr'
  ) %>% 
  print(booktabs = TRUE, caption.placement = "top", add.to.row = list(pos = as.list(rws), command = rep("\\rowcolor{whoblue!15}", length(rws))), include.rownames = FALSE, comment = FALSE, tabular.environment = 'longtable', floating = FALSE)
```
\end{fullwidth}


```{r}
# print table if output is word or html document
if(knitr::opts_knit$get("rmarkdown.pandoc.to") %in% c('docx', 'html')) knitr::kable(DisplayResult('epitable'))
```

\newpage

```{r, fig.fullwidth = TRUE, fig.height=5, fig.cap = paste0("Répresentation du taux d'attaque des cas de diarrhées aigues par 10,000 personnes, ", DisplayResult('data')$date %>% min %>% format('%d %b %Y'), " - ", DisplayResult('data')$date %>% max %>% format('%d %b %Y'), " par commune, Grand’Anse (données partielles).")}
DisplayResult('map')
```

\newpage

```{r, fig.fullwidth = TRUE, fig.height=4, fig.cap = paste0("Tendance des cas de diarrhées aigues, ", DisplayResult('data')$date %>% min %>% format('%d %b %Y'), " - ", DisplayResult('data')$date %>% max %>% format('%d %b %Y'), " par commune, Grand’Anse (données partielles).")}
# by week & commune
DisplayResult('epicurve_by_week_commune')
```

\newpage

```{r, fig.fullwidth = F, fig.height=3, fig.cap = paste0("Répartition des cas de diarrhées aigues par tranche d'age, ", DisplayResult('data')$date %>% min %>% format('%d %b %Y'), " - ", DisplayResult('data')$date %>% max %>% format('%d %b %Y'), " par commune, Grand’Anse (données partielles).")}
DisplayResult('bar_cases_by_commune')
```

\newpage

```{r, fig.fullwidth = TRUE, fig.height=4, fig.cap = paste0("Tendance des cas de diarrhées aigues, ", DisplayResult('data')$date %>% min %>% format('%d %b %Y'), " - ", DisplayResult('data')$date %>% max %>% format('%d %b %Y'), " par CTC, Grand’Anse (données partielles).")}
# by week & inst
DisplayResult('epicurve_by_week_inst')
```



## Data collection and management
### Description of the process


## Recommendations
- IM and DM/Epi should have closer collaboration
- Field epis + logs to support surveillance
- Stronger coordination required - overall surveillance, lab, epi
- Better system - exists in Angola - forms entered by WHO in morning, then DB passed to lab who enter results, which is then shared back with WHO
- Eventual plan should be for proper decentralised and disaggregated surveillance system (e.g EWARS), with single, centralised database (one source of truth from which everyone works, incl. MoH, WCO, RO and HQ)
    + plan for decentralisation only to provincial level
    + current IDSR is aggregated only
- training for staff
- reinforce surveillance on road to, and within, Kikwit
- Evaluate the sensitivity of the surveillance system (e.g. Rapid capture-recapture study)
- Somebody should bring epiinfo DB master to CC meeting and work done directly on that DB
    + or code written to compare last version of lab with what was just sent to identify those with changes


## Annexes
- Weekly epidemiological bulletin


